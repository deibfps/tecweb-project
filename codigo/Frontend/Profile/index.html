<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - Plantasia</title>
    <link rel="stylesheet" href="../variables.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body> 
    <header>
        <h1>Plantasia</h1>
        <nav>
            <ul>
                <li><a href="../Home/index.html">Home</a></li>
                <li><a href="../Home/index.html#SobreNosotros">Nosotros</a></li>
                <li><a href="../Profile/index.html">Perfil</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="profile-form">
            <h2>Tu perfil</h2>
            <h3>Cuéntanos sobre ti</h3>
            <form action="#" method="POST" id="formPerfil">

                <div class="form-group input-icon">
                    <label for="nombre">
                        <span class="label-icon"><i class="bi bi-person"></i>Nombre</span>
                    </label>
                    <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
                </div>

                <div class="form-group input-icon">
                    <label for="apellido">
                        <span class="label-icon"><i class="bi bi-person-badge"></i>Apellido</span>
                    </label>
                    <input type="text" id="apellido" name="apellido" placeholder="Apellido" required>
                </div>

                <div class="form-group input-icon">
                    <label for="pronombres">
                        <span class="label-icon"><i class="bi bi-person-lines-fill"></i>Pronombres</span>
                    </label>
                    <select id="pronombres" name="pronombres" required>
                        <option value="" disabled selected>Selecciona tus pronombres</option>
                        <option value="she/her">She/Her</option>
                        <option value="he/him">He/Him</option>
                        <option value="they/them">They/Them</option>
                        <option value="other">Otro</option>
                    </select>
                </div>

                <div class="form-group input-icon">
                    <label for="fecha-nacimiento">
                        <span class="label-icon"><i class="bi bi-calendar-event"></i>Fecha de nacimiento</span>
                    </label>
                    <input type="date" id="fecha-nacimiento" name="fecha-nacimiento" required>
                </div>

                <div class="form-group full-width input-icon">
                    <label for="biografia">
                        <span class="label-icon"><i class="bi bi-journal-text"></i>Biografía</span>
                    </label>
                    <textarea id="biografia" name="biografia" placeholder="Biografía" rows="5" required></textarea>
                </div>

                <button type="submit" class="btn-submit">Enviar</button>
            </form>
        </section>
    </main>
    <button onclick="logout()">Cerrar sesión</button>

    <footer>
        <div id="Plantasia">
        Plantasia
        </div>
        <div id="Copyright">
        Todos los derechos reservados<br>
        © 2025 Plantasia
        </div>
    </footer>
    <script>
if (!localStorage.getItem('usuarioLogueado')) {
    alert("Inicia sesión para acceder a contenido exclusivo");
    window.location.href = '../Login/index.html';
}

function logout() {
    localStorage.removeItem('usuarioLogueado');
    localStorage.removeItem('rol');
    localStorage.removeItem('id_usuario');
    window.location.href = '../Login/index.html';
}

document.addEventListener('DOMContentLoaded', function() {
    const id_usuario = localStorage.getItem('id_usuario');
    if (!id_usuario) {
        window.location.href = '../Login/index.html';
        return;
    }

    const params = new URLSearchParams(window.location.search);
    const isEdit = params.get('edit') === '1';

    // Solo redirige si NO es edición y ya tiene perfil
    if (!isEdit) {
        fetch(`http://localhost:8080/api/perfil/${id_usuario}`)
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    window.location.href = '../ProfileInfo/index.html';
                }
            })
            .catch(() => alert('Error al verificar perfil'));
    } else {
        // Si es edición, autorrellena el formulario
        fetch(`http://localhost:8080/api/perfil/${id_usuario}`)
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    document.getElementById('nombre').value = data.perfil.nombre;
                    document.getElementById('apellido').value = data.perfil.apellido;
                    document.getElementById('pronombres').value = data.perfil.pronombres;
                    document.getElementById('fecha-nacimiento').value = data.perfil.fecha_nacimiento;
                    document.getElementById('biografia').value = data.perfil.biografia;
                }
            });
    }

    document.getElementById('formPerfil').addEventListener('submit', function(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value;
        const apellido = document.getElementById('apellido').value;
        const pronombres = document.getElementById('pronombres').value;
        const fecha_nacimiento = document.getElementById('fecha-nacimiento').value;
        const biografia = document.getElementById('biografia').value;

        fetch('http://localhost:8080/api/perfil', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_usuario, nombre, apellido, pronombres, fecha_nacimiento, biografia })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = '../ProfileInfo/index.html';
            } else {
                alert(data.message || 'Error al guardar perfil');
            }
        })
        .catch(() => alert('Error de conexión con el servidor'));
    });
});
</script>
</body>
</html>